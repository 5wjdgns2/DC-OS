Konvoy

kubernetes version: 1.15.5
calico version: 3.8.2
containerd: 1.2.6
Dokcer version: 19.03.5


배포 서버 필요사항

Docker 18.09.2 이상 (Nvidia 때문에 19버전 추천)

kubectl 1.15.5 이상

```
curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl
```

```
chmod +x ./kubectl
```

```
sudo mv ./kubectl /usr/local/bin/kubectl
```
​
```
kubectl version
```







노드 마다 최소 필요사항

8core , 16G 메모리

- CentOS 7.6
- 방화벽이 비활성화
- 컨테이너가 제거
- Docker-ce가 제거
- 스왑이 비활성화





스왑 비활성화 

swapoff -a

fstab 주석



```*
mkdir konvoy-deploy
cd konvoy-deploy
```



konvoy init --provisioner=none [--cluster-name <your-specified-name>]



konvoy init --provisioner=none --addons-repositories /opt/konvoy/artifacts/kubernetes-base-addons@stable-1.16-1.2.0,/opt/konvoy/artifacts/kubeaddons-kommander@stable-1.16-1.0.0,/opt/konvoy/artifacts/kubeaddons-dispatch@stable-1.16-1.0.0 --cluster-name waih-cluster2



konvoy init --provisioner=none --cluster-name kbsys-k8s

provisioner 옵션 값은 aws,none(온프레미스 환경)

방화벽 제거 (스왑 제거)

ln -s /root/setup-file/konvoy-setup/linux_air_gapped/konvoy_v1.2.6 /usr/sbin/

sudo setenforce 0



sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
setenforce disabled



아래 2개 파일 생성

cluster.yaml, inventory.yaml  



inventory.yaml 

Ansible 설정 파일 위에 설정된 호스트 및 노드 들은 전부 ansible 설정 미리 해놓아야 함.



Ansible 설치

pip install ansible

끝



아래 파일에 호스트들 정의

/etc/ansible/hosts



사전 설치 테스트

konvoy check preflight



kubeadm init

kubeadm init --apiserver-advertise-address=192.168.0.170 --pod-network-cidr=192.168.100.0/25



sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config

chown $(id -u):$(id -g) $HOME/.kube/config



노드 docker 실행중이어야 함 (체크)

hostname 유니크

node 인터페이스 값 지정 x

proxy 값 삭제(옵션)



clean up failed konvoy deployment from cluster

konvoy reset -y 

